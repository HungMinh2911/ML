import numpy as np
import pandas as pd
import tensorflow as tf
from tensorflow import keras
import matplotlib.pyplot as plt
import plotly.express as px
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler

# Load vÃ  xá»­ lÃ½ dá»¯ liá»‡u nhÆ° cÅ©
housing_data_dataset = pd.read_csv(r"C:\Users\PC\Downloads\HousingData.csv")
training_data = housing_data_dataset.loc[:, ('MEDV','RM','LSTAT','NOX','DIS','CRIM')]

print("Sá»‘ lÆ°á»£ng NA theo cá»™t:\n", training_data.isna().sum())

dataset = training_data.copy()
dataset.loc[:, "LSTAT"] = dataset["LSTAT"].fillna(dataset["LSTAT"].mean())

print("Ma tráº­n tÆ°Æ¡ng quan:")
print(dataset.corr(numeric_only=True))

# ------------------- Classes vÃ  functions cáº£i tiáº¿n -------------------
class ExperimentSettings:
    def __init__(self, learning_rate=0.001, number_epochs=20, batch_size=50, 
                 input_features=None, hidden_layers=None, dropout_rate=0.0,
                 validation_split=0.2):
        self.learning_rate = learning_rate
        self.number_epochs = number_epochs
        self.batch_size = batch_size
        self.input_features = input_features if input_features is not None else []
        self.hidden_layers = hidden_layers if hidden_layers is not None else []
        self.dropout_rate = dropout_rate
        self.validation_split = validation_split

def create_improved_model(settings: ExperimentSettings, metrics: list) -> keras.Model:
    # Input layers cho tá»«ng feature
    inputs = {name: keras.Input(shape=(1,), name=name) for name in settings.input_features}
    
    # Concatenate táº¥t cáº£ inputs
    concatenated = keras.layers.Concatenate()(list(inputs.values()))
    
    # Normalization layer
    x = keras.layers.BatchNormalization()(concatenated)
    
    # Hidden layers
    for units in settings.hidden_layers:
        x = keras.layers.Dense(units, activation='relu')(x)
        if settings.dropout_rate > 0:
            x = keras.layers.Dropout(settings.dropout_rate)(x)
        x = keras.layers.BatchNormalization()(x)
    
    # Output layer
    output = keras.layers.Dense(units=1)(x)
    
    model = keras.Model(inputs=inputs, outputs=output)
    
    # Sá»­ dá»¥ng Adam optimizer thay vÃ¬ RMSprop
    model.compile(
        optimizer=keras.optimizers.Adam(settings.learning_rate),
        loss='mean_squared_error',
        metrics=metrics
    )
    return model

class Experiment:
    def __init__(self, name, settings, model, epochs, metric_history, val_metric_history=None):
        self.name = name
        self.settings = settings
        self.model = model
        self.epochs = epochs
        self.metric_history = metric_history
        self.val_metric_history = val_metric_history

def train_improved_model(experiment_name: str, model: keras.Model, dataset: pd.DataFrame, 
                        label_name: str, settings: ExperimentSettings) -> Experiment:
    # Chuáº©n bá»‹ dá»¯ liá»‡u
    features = {name: dataset[name].values for name in settings.input_features}
    label = dataset[label_name].values
    
    # Early stopping callback
    early_stopping = keras.callbacks.EarlyStopping(
        monitor='val_loss',
        patience=20,
        restore_best_weights=True
    )
    
    # Reduce learning rate callback
    reduce_lr = keras.callbacks.ReduceLROnPlateau(
        monitor='val_loss',
        factor=0.5,
        patience=10,
        min_lr=1e-7
    )
    
    history = model.fit(
        x=features,
        y=label,
        batch_size=settings.batch_size,
        epochs=settings.number_epochs,
        validation_split=settings.validation_split,
        callbacks=[early_stopping, reduce_lr],
        verbose=1
    )
    
    return Experiment(
        name=experiment_name,
        settings=settings,
        model=model,
        epochs=history.epoch,
        metric_history=pd.DataFrame(history.history),
    )

def plot_improved_metrics(experiment, metrics):
    """Váº½ biá»ƒu Ä‘á»“ metrics vá»›i validation"""
    fig, axes = plt.subplots(1, len(metrics), figsize=(15, 5))
    if len(metrics) == 1:
        axes = [axes]
    
    for i, metric in enumerate(metrics):
        if metric in experiment.metric_history.columns:
            axes[i].plot(experiment.epochs, experiment.metric_history[metric], 
                        label=f'Training {metric.upper()}', linewidth=2)
            
            val_metric = f'val_{metric}'
            if val_metric in experiment.metric_history.columns:
                axes[i].plot(experiment.epochs, experiment.metric_history[val_metric], 
                            label=f'Validation {metric.upper()}', linewidth=2)
            
            axes[i].set_xlabel('Epoch')
            axes[i].set_ylabel('Value')
            axes[i].set_title(f'{experiment.name} - {metric.upper()}')
            axes[i].legend()
            axes[i].grid(True)
    
    plt.tight_layout()
    plt.show()

def plot_improved_predictions(experiment, dataset, target_column):
    """Váº½ biá»ƒu Ä‘á»“ predictions vs actual cáº£i tiáº¿n"""
    # Láº¥y máº«u dá»¯ liá»‡u
    sample_data = dataset.sample(n=min(500, len(dataset)), random_state=42)
    
    # Dá»± Ä‘oÃ¡n
    features = {name: sample_data[name].values for name in experiment.settings.input_features}
    predictions = experiment.model.predict(features)
    actual = sample_data[target_column].values
    
    # TÃ­nh toÃ¡n metrics
    mse = np.mean((actual - predictions.flatten())**2)
    rmse = np.sqrt(mse)
    mae = np.mean(np.abs(actual - predictions.flatten()))
    
    # Váº½ biá»ƒu Ä‘á»“
    plt.figure(figsize=(12, 5))
    
    # Subplot 1: Predictions vs Actual
    plt.subplot(1, 2, 1)
    plt.scatter(actual, predictions.flatten(), alpha=0.6, s=30)
    
    # ÄÆ°á»ng perfect prediction
    min_val, max_val = min(actual.min(), predictions.min()), max(actual.max(), predictions.max())
    plt.plot([min_val, max_val], [min_val, max_val], 'r--', label='Perfect Prediction', linewidth=2)
    
    plt.xlabel(f'Actual {target_column}')
    plt.ylabel(f'Predicted {target_column}')
    plt.title(f'{experiment.name}\nRMSE: {rmse:.2f}, MAE: {mae:.2f}')
    plt.legend()
    plt.grid(True, alpha=0.3)
    
    # Subplot 2: Residuals
    plt.subplot(1, 2, 2)
    residuals = actual - predictions.flatten()
    plt.scatter(predictions.flatten(), residuals, alpha=0.6, s=30)
    plt.axhline(y=0, color='r', linestyle='--', linewidth=2)
    plt.xlabel(f'Predicted {target_column}')
    plt.ylabel('Residuals')
    plt.title('Residual Plot')
    plt.grid(True, alpha=0.3)
    
    plt.tight_layout()
    plt.show()

class ImprovedMLEdu:
    class results:
        plot_experiment_metrics = staticmethod(plot_improved_metrics)
        plot_model_predictions = staticmethod(plot_improved_predictions)

# ------------------- Thá»­ nghiá»‡m cÃ¡c mÃ´ hÃ¬nh khÃ¡c nhau -------------------

# Experiment 1: MÃ´ hÃ¬nh Ä‘Æ¡n giáº£n (nhÆ° cÅ©)
print("=== EXPERIMENT 1: MÃ´ hÃ¬nh Ä‘Æ¡n giáº£n (1 feature) ===")
settings_1 = ExperimentSettings(
    learning_rate=0.01,  # Giáº£m learning rate
    number_epochs=200,
    batch_size=32,       # Giáº£m batch size
    input_features=['LSTAT']
)
metrics = [keras.metrics.RootMeanSquaredError(name='rmse')]
model_1 = create_improved_model(settings_1, metrics)
experiment_1 = train_improved_model('Simple Model (1 feature)', model_1, dataset, 'MEDV', settings_1)

# Experiment 2: Nhiá»u features
print("\n=== EXPERIMENT 2: MÃ´ hÃ¬nh nhiá»u features ===")
settings_2 = ExperimentSettings(
    learning_rate=0.01,
    number_epochs=300,
    batch_size=32,
    input_features=['LSTAT', 'RM', 'NOX', 'DIS', 'CRIM'],  # DÃ¹ng nhiá»u features
    hidden_layers=[64, 32],  # ThÃªm hidden layers
    dropout_rate=0.2         # ThÃªm dropout Ä‘á»ƒ trÃ¡nh overfitting
)
model_2 = create_improved_model(settings_2, metrics)
experiment_2 = train_improved_model('Multi-feature Model', model_2, dataset, 'MEDV', settings_2)

# Experiment 3: MÃ´ hÃ¬nh phá»©c táº¡p hÆ¡n
print("\n=== EXPERIMENT 3: MÃ´ hÃ¬nh phá»©c táº¡p ===")
settings_3 = ExperimentSettings(
    learning_rate=0.005,
    number_epochs=400,
    batch_size=16,
    input_features=['LSTAT', 'RM', 'NOX', 'DIS', 'CRIM'],
    hidden_layers=[128, 64, 32, 16],  # Nhiá»u layers hÆ¡n
    dropout_rate=0.3
)
model_3 = create_improved_model(settings_3, metrics)
experiment_3 = train_improved_model('Complex Model', model_3, dataset, 'MEDV', settings_3)

# ------------------- So sÃ¡nh káº¿t quáº£ -------------------
ml_edu = ImprovedMLEdu()

print("\n=== Káº¾T QUáº¢ EXPERIMENT 1 ===")
ml_edu.results.plot_experiment_metrics(experiment_1, ['rmse'])
ml_edu.results.plot_model_predictions(experiment_1, dataset, 'MEDV')

print("\n=== Káº¾T QUáº¢ EXPERIMENT 2 ===")
ml_edu.results.plot_experiment_metrics(experiment_2, ['rmse'])
ml_edu.results.plot_model_predictions(experiment_2, dataset, 'MEDV')

print("\n=== Káº¾T QUáº¢ EXPERIMENT 3 ===")
ml_edu.results.plot_experiment_metrics(experiment_3, ['rmse'])
ml_edu.results.plot_model_predictions(experiment_3, dataset, 'MEDV')

# So sÃ¡nh RMSE cuá»‘i cÃ¹ng
print("\n=== SO SÃNH RMSE CUá»I CÃ™NG ===")
final_rmse_1 = experiment_1.metric_history['val_rmse'].iloc[-1]
final_rmse_2 = experiment_2.metric_history['val_rmse'].iloc[-1]
final_rmse_3 = experiment_3.metric_history['val_rmse'].iloc[-1]

print(f"Experiment 1 (1 feature): RMSE = {final_rmse_1:.3f}")
print(f"Experiment 2 (5 features): RMSE = {final_rmse_2:.3f}")
print(f"Experiment 3 (Complex): RMSE = {final_rmse_3:.3f}")

best_experiment = min([
    (final_rmse_1, "Experiment 1"),
    (final_rmse_2, "Experiment 2"), 
    (final_rmse_3, "Experiment 3")
])
print(f"\nMÃ´ hÃ¬nh tá»‘t nháº¥t: {best_experiment[1]} vá»›i RMSE = {best_experiment[0]:.3f}")

# ================= CHá»¨C NÄ‚NG Dá»° ÄOÃN GIÃ NHÃ€ (STYLE Má»šI) =================

def format_currency(value):
    """Format giÃ¡ trá»‹ thÃ nh dáº¡ng tiá»n tá»‡"""
    return f"${value:.2f}k"

def format_feature_value(feature_name, value):
    """Format giÃ¡ trá»‹ feature cho dá»… Ä‘á»c"""
    format_rules = {
        'LSTAT': f"{value:.1f}%",
        'RM': f"{value:.1f} rooms", 
        'NOX': f"{value:.3f} ppm",
        'DIS': f"{value:.2f} miles",
        'CRIM': f"{value:.2f}/1000"
    }
    return format_rules.get(feature_name, f"{value:.2f}")

def build_housing_batch(df, batch_size):
    """Táº¡o batch ngáº«u nhiÃªn tá»« housing dataset"""
    batch = df.sample(n=batch_size).copy()
    batch.set_index(np.arange(batch_size), inplace=True)
    return batch

def predict_housing_prices(model, df, features, label, batch_size=20):
    """
    Dá»± Ä‘oÃ¡n giÃ¡ nhÃ  cho má»™t batch vÃ  so sÃ¡nh vá»›i giÃ¡ thá»±c táº¿
    
    Args:
        model: MÃ´ hÃ¬nh Keras Ä‘Ã£ train
        df: Housing dataset  
        features: List cÃ¡c feature names
        label: TÃªn cá»™t target (MEDV)
        batch_size: Sá»‘ máº«u Ä‘á»ƒ test
    
    Returns:
        pd.DataFrame: Káº¿t quáº£ dá»± Ä‘oÃ¡n vá»›i format Ä‘áº¹p
    """
    batch = build_housing_batch(df, batch_size)
    
    # Dá»± Ä‘oÃ¡n báº±ng model
    predicted_values = model.predict_on_batch(
        x={name: batch[name].values for name in features}
    )
    
    # Táº¡o dictionary chá»©a káº¿t quáº£
    data = {
        "PREDICTED_PRICE": [], 
        "ACTUAL_PRICE": [], 
        "L1_ERROR": [],
        "L1_ERROR_PCT": []
    }
    
    # ThÃªm cÃ¡c cá»™t feature vÃ o data
    for feature in features:
        data[feature] = []
    
    # Äiá»n dá»¯ liá»‡u cho tá»«ng sample
    for i in range(batch_size):
        predicted = predicted_values[i][0]
        actual = batch.at[i, label]
        l1_error = abs(actual - predicted)
        error_pct = (l1_error / actual) * 100
        
        data["PREDICTED_PRICE"].append(format_currency(predicted))
        data["ACTUAL_PRICE"].append(format_currency(actual))
        data["L1_ERROR"].append(format_currency(l1_error))
        data["L1_ERROR_PCT"].append(f"{error_pct:.1f}%")
        
        # ThÃªm giÃ¡ trá»‹ cÃ¡c features
        for feature in features:
            data[feature].append(format_feature_value(feature, batch.at[i, feature]))
    
    output_df = pd.DataFrame(data)
    return output_df

def show_housing_predictions(output_df, model_name="Housing Model"):
    """Hiá»ƒn thá»‹ káº¿t quáº£ dá»± Ä‘oÃ¡n vá»›i format Ä‘áº¹p"""
    header = "=" * 100
    banner = header + "\n" + "|" + f"ğŸ  {model_name.upper()} - PRICE PREDICTIONS ğŸ ".center(98) + "|" + "\n" + header
    print(banner)
    
    # Hiá»ƒn thá»‹ DataFrame vá»›i format Ä‘áº¹p
    pd.set_option('display.max_columns', None)
    pd.set_option('display.width', None) 
    pd.set_option('display.max_colwidth', 15)
    
    print(output_df.to_string(index=True))
    
    # Thá»‘ng kÃª tá»•ng quan
    print("\n" + "-" * 100)
    print("ğŸ“Š THá»NG KÃŠ Tá»”NG QUAN:")
    
    # Parse láº¡i giÃ¡ trá»‹ tá»« string Ä‘á»ƒ tÃ­nh toÃ¡n
    predicted_vals = [float(x.replace('

# ================= VÃ Dá»¤ NGáº®N Gá»ŒN =================

# Chá»n mÃ´ hÃ¬nh tá»‘t nháº¥t
experiments = [experiment_1, experiment_2, experiment_3] 
rmse_scores = [
    experiment_1.metric_history['val_rmse'].iloc[-1] if 'val_rmse' in experiment_1.metric_history else experiment_1.metric_history['rmse'].iloc[-1],
    experiment_2.metric_history['val_rmse'].iloc[-1] if 'val_rmse' in experiment_2.metric_history else experiment_2.metric_history['rmse'].iloc[-1], 
    experiment_3.metric_history['val_rmse'].iloc[-1] if 'val_rmse' in experiment_3.metric_history else experiment_3.metric_history['rmse'].iloc[-1]
]
best_idx = np.argmin(rmse_scores)
best_model = experiments[best_idx]

print(f"\nğŸ† MÃ´ hÃ¬nh tá»‘t nháº¥t: {best_model.name} (RMSE: {rmse_scores[best_idx]:.3f})")

# VÃ­ dá»¥ dá»± Ä‘oÃ¡n batch
predictions = predict_housing_prices(best_model.model, dataset, 
                                   best_model.settings.input_features, 'MEDV', 8)
show_housing_predictions(predictions, best_model.name)

# VÃ­ dá»¥ dá»± Ä‘oÃ¡n Ä‘Æ¡n
if len(best_model.settings.input_features) > 1:
    price = predict_single_house(best_model, LSTAT=8.5, RM=6.8, NOX=0.45, DIS=4.2, CRIM=2.1)
else:
    price = predict_single_house(best_model, LSTAT=12.5)

print(f"ğŸ’° Single prediction: {format_currency(price)}")

# Usage
print(f"\nğŸ“ Sá»­ dá»¥ng:")
print(f"predict_single_house(best_model, LSTAT=10, RM=6.5, ...)")
print(f"predict_housing_prices(best_model.model, dataset, features, 'MEDV', 10)")
, '').replace('k', '')) for x in output_df['PREDICTED_PRICE']]
    actual_vals = [float(x.replace('

def predict_with_examples():
    """Dá»± Ä‘oÃ¡n vá»›i cÃ¡c vÃ­ dá»¥ cá»¥ thá»ƒ"""
    print("\n" + "="*60)
    print("           Dá»° ÄOÃN GIÃ NHÃ€ Vá»šI CÃC THÃ”NG Sá» Cá»¤ THá»‚")
    print("="*60)
    
    # Chá»n mÃ´ hÃ¬nh tá»‘t nháº¥t
    experiments = [experiment_1, experiment_2, experiment_3]
    rmse_scores = [final_rmse_1, final_rmse_2, final_rmse_3]
    best_idx = np.argmin(rmse_scores)
    best_model = experiments[best_idx]
    
    print(f"Sá»­ dá»¥ng {best_model.name} (RMSE: {rmse_scores[best_idx]:.3f})")
    print("\nGiáº£i thÃ­ch cÃ¡c thÃ´ng sá»‘:")
    print("- LSTAT: % dÃ¢n sá»‘ thu nháº­p tháº¥p (cÃ ng tháº¥p cÃ ng tá»‘t)")
    print("- RM: Sá»‘ phÃ²ng trung bÃ¬nh (cÃ ng nhiá»u cÃ ng tá»‘t)")  
    print("- NOX: Ná»“ng Ä‘á»™ NOx (cÃ ng tháº¥p cÃ ng tá»‘t)")
    print("- DIS: Khoáº£ng cÃ¡ch Ä‘áº¿n trung tÃ¢m viá»‡c lÃ m (cÃ ng gáº§n cÃ ng tá»‘t)")
    print("- CRIM: Tá»· lá»‡ tá»™i pháº¡m (cÃ ng tháº¥p cÃ ng tá»‘t)")
    
    # VÃ­ dá»¥ 1: NhÃ  tá»‘t
    print("\n--- VÃ Dá»¤ 1: Khu vá»±c tá»‘t ---")
    if best_model.name != 'Simple Model (1 feature)':
        example_1 = {
            'LSTAT': 5.0,    # Thu nháº­p cao
            'RM': 7.5,       # Nhiá»u phÃ²ng
            'NOX': 0.4,      # Ã” nhiá»…m tháº¥p  
            'DIS': 8.0,      # Gáº§n trung tÃ¢m
            'CRIM': 0.1      # Tá»· lá»‡ tá»™i pháº¡m tháº¥p
        }
        price_1 = predict_house_price(best_model, **example_1)
        print("ThÃ´ng sá»‘:")
        for k, v in example_1.items():
            print(f"  {k}: {v}")
        print(f"â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_1:.1f}k")
    else:
        example_1 = {'LSTAT': 5.0}
        price_1 = predict_house_price(best_model, **example_1)
        print(f"LSTAT: {example_1['LSTAT']} â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_1:.1f}k")
    
    # VÃ­ dá»¥ 2: NhÃ  trung bÃ¬nh
    print("\n--- VÃ Dá»¤ 2: Khu vá»±c trung bÃ¬nh ---")
    if best_model.name != 'Simple Model (1 feature)':
        example_2 = {
            'LSTAT': 12.0,   # Thu nháº­p trung bÃ¬nh
            'RM': 6.0,       # Sá»‘ phÃ²ng trung bÃ¬nh
            'NOX': 0.55,     # Ã” nhiá»…m trung bÃ¬nh
            'DIS': 4.0,      # Khoáº£ng cÃ¡ch trung bÃ¬nh
            'CRIM': 5.0      # Tá»· lá»‡ tá»™i pháº¡m trung bÃ¬nh
        }
        price_2 = predict_house_price(best_model, **example_2)
        print("ThÃ´ng sá»‘:")
        for k, v in example_2.items():
            print(f"  {k}: {v}")
        print(f"â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_2:.1f}k")
    else:
        example_2 = {'LSTAT': 12.0}
        price_2 = predict_house_price(best_model, **example_2)
        print(f"LSTAT: {example_2['LSTAT']} â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_2:.1f}k")
    
    # VÃ­ dá»¥ 3: NhÃ  kÃ©m
    print("\n--- VÃ Dá»¤ 3: Khu vá»±c kÃ©m ---")
    if best_model.name != 'Simple Model (1 feature)':
        example_3 = {
            'LSTAT': 25.0,   # Thu nháº­p tháº¥p
            'RM': 4.5,       # Ãt phÃ²ng
            'NOX': 0.8,      # Ã” nhiá»…m cao
            'DIS': 1.5,      # Xa trung tÃ¢m
            'CRIM': 20.0     # Tá»· lá»‡ tá»™i pháº¡m cao
        }
        price_3 = predict_house_price(best_model, **example_3)
        print("ThÃ´ng sá»‘:")
        for k, v in example_3.items():
            print(f"  {k}: {v}")
        print(f"â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_3:.1f}k")
    else:
        example_3 = {'LSTAT': 25.0}
        price_3 = predict_house_price(best_model, **example_3)
        print(f"LSTAT: {example_3['LSTAT']} â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_3:.1f}k")

def predict_custom():
    """Cho phÃ©p user nháº­p thÃ´ng sá»‘ tÃ¹y chá»‰nh"""
    print("\n" + "="*60)
    print("           Dá»° ÄOÃN GIÃ NHÃ€ Vá»šI THÃ”NG Sá» TÃ™Y CHá»ˆNH")
    print("="*60)
    
    # Chá»n mÃ´ hÃ¬nh tá»‘t nháº¥t
    experiments = [experiment_1, experiment_2, experiment_3]
    rmse_scores = [final_rmse_1, final_rmse_2, final_rmse_3]
    best_idx = np.argmin(rmse_scores)
    best_model = experiments[best_idx]
    
    print(f"Sá»­ dá»¥ng {best_model.name}")
    print("Nháº­p cÃ¡c thÃ´ng sá»‘ (Enter Ä‘á»ƒ bá» qua náº¿u khÃ´ng biáº¿t):")
    
    user_input = {}
    
    if 'LSTAT' in best_model.settings.input_features:
        lstat = input("LSTAT (% dÃ¢n sá»‘ thu nháº­p tháº¥p, VD: 10.5): ").strip()
        if lstat:
            user_input['LSTAT'] = float(lstat)
    
    if 'RM' in best_model.settings.input_features:
        rm = input("RM (Sá»‘ phÃ²ng trung bÃ¬nh, VD: 6.2): ").strip()
        if rm:
            user_input['RM'] = float(rm)
            
    if 'NOX' in best_model.settings.input_features:
        nox = input("NOX (Ná»“ng Ä‘á»™ NOx, VD: 0.5): ").strip()
        if nox:
            user_input['NOX'] = float(nox)
            
    if 'DIS' in best_model.settings.input_features:
        dis = input("DIS (Khoáº£ng cÃ¡ch trung tÃ¢m viá»‡c lÃ m, VD: 4.0): ").strip()
        if dis:
            user_input['DIS'] = float(dis)
            
    if 'CRIM' in best_model.settings.input_features:
        crim = input("CRIM (Tá»· lá»‡ tá»™i pháº¡m, VD: 2.5): ").strip()
        if crim:
            user_input['CRIM'] = float(crim)
    
    if len(user_input) == len(best_model.settings.input_features):
        predicted_price = predict_house_price(best_model, **user_input)
        print(f"\nğŸ  GiÃ¡ nhÃ  dá»± Ä‘oÃ¡n: ${predicted_price:.1f}k")
        
        # ÄÃ¡nh giÃ¡
        if predicted_price > 30:
            print("   â†’ Khu vá»±c cao cáº¥p! ğŸ˜ï¸")
        elif predicted_price > 20:
            print("   â†’ Khu vá»±c trung bÃ¬nh khÃ¡ ğŸ ")
        elif predicted_price > 15:
            print("   â†’ Khu vá»±c trung bÃ¬nh ğŸ˜ï¸")
        else:
            print("   â†’ Khu vá»±c bÃ¬nh dÃ¢n ğŸšï¸")
    else:
        print("âš ï¸  Cáº§n nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng sá»‘ Ä‘á»ƒ dá»± Ä‘oÃ¡n!")

# Cháº¡y cÃ¡c vÃ­ dá»¥ dá»± Ä‘oÃ¡n
predict_with_examples()

print("\n" + "="*60)
print("Báº¡n cÃ³ thá»ƒ gá»i predict_custom() Ä‘á»ƒ nháº­p thÃ´ng sá»‘ tÃ¹y chá»‰nh")
print("Hoáº·c dÃ¹ng predict_house_price(best_model, LSTAT=10, RM=6, ...)")
print("="*60)
, '').replace('k', '')) for x in output_df['ACTUAL_PRICE']]
    errors = [float(x.replace('

def predict_with_examples():
    """Dá»± Ä‘oÃ¡n vá»›i cÃ¡c vÃ­ dá»¥ cá»¥ thá»ƒ"""
    print("\n" + "="*60)
    print("           Dá»° ÄOÃN GIÃ NHÃ€ Vá»šI CÃC THÃ”NG Sá» Cá»¤ THá»‚")
    print("="*60)
    
    # Chá»n mÃ´ hÃ¬nh tá»‘t nháº¥t
    experiments = [experiment_1, experiment_2, experiment_3]
    rmse_scores = [final_rmse_1, final_rmse_2, final_rmse_3]
    best_idx = np.argmin(rmse_scores)
    best_model = experiments[best_idx]
    
    print(f"Sá»­ dá»¥ng {best_model.name} (RMSE: {rmse_scores[best_idx]:.3f})")
    print("\nGiáº£i thÃ­ch cÃ¡c thÃ´ng sá»‘:")
    print("- LSTAT: % dÃ¢n sá»‘ thu nháº­p tháº¥p (cÃ ng tháº¥p cÃ ng tá»‘t)")
    print("- RM: Sá»‘ phÃ²ng trung bÃ¬nh (cÃ ng nhiá»u cÃ ng tá»‘t)")  
    print("- NOX: Ná»“ng Ä‘á»™ NOx (cÃ ng tháº¥p cÃ ng tá»‘t)")
    print("- DIS: Khoáº£ng cÃ¡ch Ä‘áº¿n trung tÃ¢m viá»‡c lÃ m (cÃ ng gáº§n cÃ ng tá»‘t)")
    print("- CRIM: Tá»· lá»‡ tá»™i pháº¡m (cÃ ng tháº¥p cÃ ng tá»‘t)")
    
    # VÃ­ dá»¥ 1: NhÃ  tá»‘t
    print("\n--- VÃ Dá»¤ 1: Khu vá»±c tá»‘t ---")
    if best_model.name != 'Simple Model (1 feature)':
        example_1 = {
            'LSTAT': 5.0,    # Thu nháº­p cao
            'RM': 7.5,       # Nhiá»u phÃ²ng
            'NOX': 0.4,      # Ã” nhiá»…m tháº¥p  
            'DIS': 8.0,      # Gáº§n trung tÃ¢m
            'CRIM': 0.1      # Tá»· lá»‡ tá»™i pháº¡m tháº¥p
        }
        price_1 = predict_house_price(best_model, **example_1)
        print("ThÃ´ng sá»‘:")
        for k, v in example_1.items():
            print(f"  {k}: {v}")
        print(f"â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_1:.1f}k")
    else:
        example_1 = {'LSTAT': 5.0}
        price_1 = predict_house_price(best_model, **example_1)
        print(f"LSTAT: {example_1['LSTAT']} â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_1:.1f}k")
    
    # VÃ­ dá»¥ 2: NhÃ  trung bÃ¬nh
    print("\n--- VÃ Dá»¤ 2: Khu vá»±c trung bÃ¬nh ---")
    if best_model.name != 'Simple Model (1 feature)':
        example_2 = {
            'LSTAT': 12.0,   # Thu nháº­p trung bÃ¬nh
            'RM': 6.0,       # Sá»‘ phÃ²ng trung bÃ¬nh
            'NOX': 0.55,     # Ã” nhiá»…m trung bÃ¬nh
            'DIS': 4.0,      # Khoáº£ng cÃ¡ch trung bÃ¬nh
            'CRIM': 5.0      # Tá»· lá»‡ tá»™i pháº¡m trung bÃ¬nh
        }
        price_2 = predict_house_price(best_model, **example_2)
        print("ThÃ´ng sá»‘:")
        for k, v in example_2.items():
            print(f"  {k}: {v}")
        print(f"â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_2:.1f}k")
    else:
        example_2 = {'LSTAT': 12.0}
        price_2 = predict_house_price(best_model, **example_2)
        print(f"LSTAT: {example_2['LSTAT']} â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_2:.1f}k")
    
    # VÃ­ dá»¥ 3: NhÃ  kÃ©m
    print("\n--- VÃ Dá»¤ 3: Khu vá»±c kÃ©m ---")
    if best_model.name != 'Simple Model (1 feature)':
        example_3 = {
            'LSTAT': 25.0,   # Thu nháº­p tháº¥p
            'RM': 4.5,       # Ãt phÃ²ng
            'NOX': 0.8,      # Ã” nhiá»…m cao
            'DIS': 1.5,      # Xa trung tÃ¢m
            'CRIM': 20.0     # Tá»· lá»‡ tá»™i pháº¡m cao
        }
        price_3 = predict_house_price(best_model, **example_3)
        print("ThÃ´ng sá»‘:")
        for k, v in example_3.items():
            print(f"  {k}: {v}")
        print(f"â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_3:.1f}k")
    else:
        example_3 = {'LSTAT': 25.0}
        price_3 = predict_house_price(best_model, **example_3)
        print(f"LSTAT: {example_3['LSTAT']} â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_3:.1f}k")

def predict_custom():
    """Cho phÃ©p user nháº­p thÃ´ng sá»‘ tÃ¹y chá»‰nh"""
    print("\n" + "="*60)
    print("           Dá»° ÄOÃN GIÃ NHÃ€ Vá»šI THÃ”NG Sá» TÃ™Y CHá»ˆNH")
    print("="*60)
    
    # Chá»n mÃ´ hÃ¬nh tá»‘t nháº¥t
    experiments = [experiment_1, experiment_2, experiment_3]
    rmse_scores = [final_rmse_1, final_rmse_2, final_rmse_3]
    best_idx = np.argmin(rmse_scores)
    best_model = experiments[best_idx]
    
    print(f"Sá»­ dá»¥ng {best_model.name}")
    print("Nháº­p cÃ¡c thÃ´ng sá»‘ (Enter Ä‘á»ƒ bá» qua náº¿u khÃ´ng biáº¿t):")
    
    user_input = {}
    
    if 'LSTAT' in best_model.settings.input_features:
        lstat = input("LSTAT (% dÃ¢n sá»‘ thu nháº­p tháº¥p, VD: 10.5): ").strip()
        if lstat:
            user_input['LSTAT'] = float(lstat)
    
    if 'RM' in best_model.settings.input_features:
        rm = input("RM (Sá»‘ phÃ²ng trung bÃ¬nh, VD: 6.2): ").strip()
        if rm:
            user_input['RM'] = float(rm)
            
    if 'NOX' in best_model.settings.input_features:
        nox = input("NOX (Ná»“ng Ä‘á»™ NOx, VD: 0.5): ").strip()
        if nox:
            user_input['NOX'] = float(nox)
            
    if 'DIS' in best_model.settings.input_features:
        dis = input("DIS (Khoáº£ng cÃ¡ch trung tÃ¢m viá»‡c lÃ m, VD: 4.0): ").strip()
        if dis:
            user_input['DIS'] = float(dis)
            
    if 'CRIM' in best_model.settings.input_features:
        crim = input("CRIM (Tá»· lá»‡ tá»™i pháº¡m, VD: 2.5): ").strip()
        if crim:
            user_input['CRIM'] = float(crim)
    
    if len(user_input) == len(best_model.settings.input_features):
        predicted_price = predict_house_price(best_model, **user_input)
        print(f"\nğŸ  GiÃ¡ nhÃ  dá»± Ä‘oÃ¡n: ${predicted_price:.1f}k")
        
        # ÄÃ¡nh giÃ¡
        if predicted_price > 30:
            print("   â†’ Khu vá»±c cao cáº¥p! ğŸ˜ï¸")
        elif predicted_price > 20:
            print("   â†’ Khu vá»±c trung bÃ¬nh khÃ¡ ğŸ ")
        elif predicted_price > 15:
            print("   â†’ Khu vá»±c trung bÃ¬nh ğŸ˜ï¸")
        else:
            print("   â†’ Khu vá»±c bÃ¬nh dÃ¢n ğŸšï¸")
    else:
        print("âš ï¸  Cáº§n nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng sá»‘ Ä‘á»ƒ dá»± Ä‘oÃ¡n!")

# Cháº¡y cÃ¡c vÃ­ dá»¥ dá»± Ä‘oÃ¡n
predict_with_examples()

print("\n" + "="*60)
print("Báº¡n cÃ³ thá»ƒ gá»i predict_custom() Ä‘á»ƒ nháº­p thÃ´ng sá»‘ tÃ¹y chá»‰nh")
print("Hoáº·c dÃ¹ng predict_house_price(best_model, LSTAT=10, RM=6, ...)")
print("="*60)
, '').replace('k', '')) for x in output_df['L1_ERROR']]
    
    print(f"   â€¢ GiÃ¡ trung bÃ¬nh thá»±c táº¿: ${np.mean(actual_vals):.2f}k")
    print(f"   â€¢ GiÃ¡ trung bÃ¬nh dá»± Ä‘oÃ¡n: ${np.mean(predicted_vals):.2f}k") 
    print(f"   â€¢ Sai sá»‘ trung bÃ¬nh (MAE): ${np.mean(errors):.2f}k")
    print(f"   â€¢ Sai sá»‘ lá»›n nháº¥t: ${np.max(errors):.2f}k")
    print(f"   â€¢ Sai sá»‘ nhá» nháº¥t: ${np.min(errors):.2f}k")
    print("=" * 100)

def predict_single_house(experiment, **feature_values):
    """
    Dá»± Ä‘oÃ¡n giÃ¡ 1 cÄƒn nhÃ  cá»¥ thá»ƒ
    
    Args:
        experiment: ThÃ­ nghiá»‡m Ä‘Ã£ train
        **feature_values: CÃ¡c thÃ´ng sá»‘ (VD: LSTAT=10.5, RM=6.2, ...)
    
    Returns:
        float: GiÃ¡ nhÃ  dá»± Ä‘oÃ¡n
    """
    # Kiá»ƒm tra xem cÃ¡c features cÃ³ trong mÃ´ hÃ¬nh khÃ´ng
    missing_features = set(experiment.settings.input_features) - set(feature_values.keys())
    if missing_features:
        raise ValueError(f"Thiáº¿u cÃ¡c features: {missing_features}")
    
    # Chuáº©n bá»‹ input cho model
    input_data = {}
    for feature in experiment.settings.input_features:
        input_data[feature] = np.array([feature_values[feature]])
    
    # Dá»± Ä‘oÃ¡n
    prediction = experiment.model.predict(input_data, verbose=0)
    return prediction[0][0]

def demonstrate_predictions():
    """Demo cÃ¡c chá»©c nÄƒng dá»± Ä‘oÃ¡n má»›i"""
    print("\nğŸ¯ DEMO: Dá»° ÄOÃN Vá»šI STYLE Má»šI")
    print("=" * 80)
    
    # Chá»n mÃ´ hÃ¬nh tá»‘t nháº¥t
    experiments = [experiment_1, experiment_2, experiment_3] 
    rmse_scores = [
        experiment_1.metric_history['val_rmse'].iloc[-1] if 'val_rmse' in experiment_1.metric_history else experiment_1.metric_history['rmse'].iloc[-1],
        experiment_2.metric_history['val_rmse'].iloc[-1] if 'val_rmse' in experiment_2.metric_history else experiment_2.metric_history['rmse'].iloc[-1], 
        experiment_3.metric_history['val_rmse'].iloc[-1] if 'val_rmse' in experiment_3.metric_history else experiment_3.metric_history['rmse'].iloc[-1]
    ]
    best_idx = np.argmin(rmse_scores)
    best_experiment = experiments[best_idx]
    
    print(f"ğŸ† Sá»­ dá»¥ng: {best_experiment.name} (RMSE: {rmse_scores[best_idx]:.3f})")
    
    # Demo 1: Dá»± Ä‘oÃ¡n batch
    print(f"\nğŸ“‹ BATCH PREDICTION - Testing {best_experiment.name}")
    predictions_df = predict_housing_prices(
        model=best_experiment.model,
        df=dataset, 
        features=best_experiment.settings.input_features,
        label='MEDV',
        batch_size=15
    )
    show_housing_predictions(predictions_df, best_experiment.name)
    
    # Demo 2: Dá»± Ä‘oÃ¡n Ä‘Æ¡n láº»
    print(f"\nğŸ  SINGLE HOUSE PREDICTION")
    print("-" * 50)
    
    if len(best_experiment.settings.input_features) > 1:
        # Multi-feature model
        example_house = {
            'LSTAT': 8.5,   # 8.5% dÃ¢n sá»‘ thu nháº­p tháº¥p  
            'RM': 6.8,      # 6.8 phÃ²ng trung bÃ¬nh
            'NOX': 0.45,    # Ná»“ng Ä‘á»™ NOx = 0.45
            'DIS': 4.2,     # CÃ¡ch trung tÃ¢m 4.2 miles
            'CRIM': 2.1     # Tá»· lá»‡ tá»™i pháº¡m = 2.1/1000
        }
        price = predict_single_house(best_experiment, **example_house)
        
        print("ğŸ¡ ThÃ´ng sá»‘ cÄƒn nhÃ :")
        for feature, value in example_house.items():
            formatted_val = format_feature_value(feature, value)
            print(f"   â€¢ {feature}: {formatted_val}")
        print(f"\nğŸ’° GiÃ¡ dá»± Ä‘oÃ¡n: {format_currency(price)}")
        
    else:
        # Single-feature model
        example_house = {'LSTAT': 12.5}
        price = predict_single_house(best_experiment, **example_house)
        print(f"ğŸ¡ LSTAT: {format_feature_value('LSTAT', example_house['LSTAT'])}")
        print(f"ğŸ’° GiÃ¡ dá»± Ä‘oÃ¡n: {format_currency(price)}")
    
    return best_experiment, predictions_df

def predict_with_examples():
    """Dá»± Ä‘oÃ¡n vá»›i cÃ¡c vÃ­ dá»¥ cá»¥ thá»ƒ"""
    print("\n" + "="*60)
    print("           Dá»° ÄOÃN GIÃ NHÃ€ Vá»šI CÃC THÃ”NG Sá» Cá»¤ THá»‚")
    print("="*60)
    
    # Chá»n mÃ´ hÃ¬nh tá»‘t nháº¥t
    experiments = [experiment_1, experiment_2, experiment_3]
    rmse_scores = [final_rmse_1, final_rmse_2, final_rmse_3]
    best_idx = np.argmin(rmse_scores)
    best_model = experiments[best_idx]
    
    print(f"Sá»­ dá»¥ng {best_model.name} (RMSE: {rmse_scores[best_idx]:.3f})")
    print("\nGiáº£i thÃ­ch cÃ¡c thÃ´ng sá»‘:")
    print("- LSTAT: % dÃ¢n sá»‘ thu nháº­p tháº¥p (cÃ ng tháº¥p cÃ ng tá»‘t)")
    print("- RM: Sá»‘ phÃ²ng trung bÃ¬nh (cÃ ng nhiá»u cÃ ng tá»‘t)")  
    print("- NOX: Ná»“ng Ä‘á»™ NOx (cÃ ng tháº¥p cÃ ng tá»‘t)")
    print("- DIS: Khoáº£ng cÃ¡ch Ä‘áº¿n trung tÃ¢m viá»‡c lÃ m (cÃ ng gáº§n cÃ ng tá»‘t)")
    print("- CRIM: Tá»· lá»‡ tá»™i pháº¡m (cÃ ng tháº¥p cÃ ng tá»‘t)")
    
    # VÃ­ dá»¥ 1: NhÃ  tá»‘t
    print("\n--- VÃ Dá»¤ 1: Khu vá»±c tá»‘t ---")
    if best_model.name != 'Simple Model (1 feature)':
        example_1 = {
            'LSTAT': 5.0,    # Thu nháº­p cao
            'RM': 7.5,       # Nhiá»u phÃ²ng
            'NOX': 0.4,      # Ã” nhiá»…m tháº¥p  
            'DIS': 8.0,      # Gáº§n trung tÃ¢m
            'CRIM': 0.1      # Tá»· lá»‡ tá»™i pháº¡m tháº¥p
        }
        price_1 = predict_house_price(best_model, **example_1)
        print("ThÃ´ng sá»‘:")
        for k, v in example_1.items():
            print(f"  {k}: {v}")
        print(f"â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_1:.1f}k")
    else:
        example_1 = {'LSTAT': 5.0}
        price_1 = predict_house_price(best_model, **example_1)
        print(f"LSTAT: {example_1['LSTAT']} â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_1:.1f}k")
    
    # VÃ­ dá»¥ 2: NhÃ  trung bÃ¬nh
    print("\n--- VÃ Dá»¤ 2: Khu vá»±c trung bÃ¬nh ---")
    if best_model.name != 'Simple Model (1 feature)':
        example_2 = {
            'LSTAT': 12.0,   # Thu nháº­p trung bÃ¬nh
            'RM': 6.0,       # Sá»‘ phÃ²ng trung bÃ¬nh
            'NOX': 0.55,     # Ã” nhiá»…m trung bÃ¬nh
            'DIS': 4.0,      # Khoáº£ng cÃ¡ch trung bÃ¬nh
            'CRIM': 5.0      # Tá»· lá»‡ tá»™i pháº¡m trung bÃ¬nh
        }
        price_2 = predict_house_price(best_model, **example_2)
        print("ThÃ´ng sá»‘:")
        for k, v in example_2.items():
            print(f"  {k}: {v}")
        print(f"â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_2:.1f}k")
    else:
        example_2 = {'LSTAT': 12.0}
        price_2 = predict_house_price(best_model, **example_2)
        print(f"LSTAT: {example_2['LSTAT']} â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_2:.1f}k")
    
    # VÃ­ dá»¥ 3: NhÃ  kÃ©m
    print("\n--- VÃ Dá»¤ 3: Khu vá»±c kÃ©m ---")
    if best_model.name != 'Simple Model (1 feature)':
        example_3 = {
            'LSTAT': 25.0,   # Thu nháº­p tháº¥p
            'RM': 4.5,       # Ãt phÃ²ng
            'NOX': 0.8,      # Ã” nhiá»…m cao
            'DIS': 1.5,      # Xa trung tÃ¢m
            'CRIM': 20.0     # Tá»· lá»‡ tá»™i pháº¡m cao
        }
        price_3 = predict_house_price(best_model, **example_3)
        print("ThÃ´ng sá»‘:")
        for k, v in example_3.items():
            print(f"  {k}: {v}")
        print(f"â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_3:.1f}k")
    else:
        example_3 = {'LSTAT': 25.0}
        price_3 = predict_house_price(best_model, **example_3)
        print(f"LSTAT: {example_3['LSTAT']} â†’ GiÃ¡ dá»± Ä‘oÃ¡n: ${price_3:.1f}k")

def predict_custom():
    """Cho phÃ©p user nháº­p thÃ´ng sá»‘ tÃ¹y chá»‰nh"""
    print("\n" + "="*60)
    print("           Dá»° ÄOÃN GIÃ NHÃ€ Vá»šI THÃ”NG Sá» TÃ™Y CHá»ˆNH")
    print("="*60)
    
    # Chá»n mÃ´ hÃ¬nh tá»‘t nháº¥t
    experiments = [experiment_1, experiment_2, experiment_3]
    rmse_scores = [final_rmse_1, final_rmse_2, final_rmse_3]
    best_idx = np.argmin(rmse_scores)
    best_model = experiments[best_idx]
    
    print(f"Sá»­ dá»¥ng {best_model.name}")
    print("Nháº­p cÃ¡c thÃ´ng sá»‘ (Enter Ä‘á»ƒ bá» qua náº¿u khÃ´ng biáº¿t):")
    
    user_input = {}
    
    if 'LSTAT' in best_model.settings.input_features:
        lstat = input("LSTAT (% dÃ¢n sá»‘ thu nháº­p tháº¥p, VD: 10.5): ").strip()
        if lstat:
            user_input['LSTAT'] = float(lstat)
    
    if 'RM' in best_model.settings.input_features:
        rm = input("RM (Sá»‘ phÃ²ng trung bÃ¬nh, VD: 6.2): ").strip()
        if rm:
            user_input['RM'] = float(rm)
            
    if 'NOX' in best_model.settings.input_features:
        nox = input("NOX (Ná»“ng Ä‘á»™ NOx, VD: 0.5): ").strip()
        if nox:
            user_input['NOX'] = float(nox)
            
    if 'DIS' in best_model.settings.input_features:
        dis = input("DIS (Khoáº£ng cÃ¡ch trung tÃ¢m viá»‡c lÃ m, VD: 4.0): ").strip()
        if dis:
            user_input['DIS'] = float(dis)
            
    if 'CRIM' in best_model.settings.input_features:
        crim = input("CRIM (Tá»· lá»‡ tá»™i pháº¡m, VD: 2.5): ").strip()
        if crim:
            user_input['CRIM'] = float(crim)
    
    if len(user_input) == len(best_model.settings.input_features):
        predicted_price = predict_house_price(best_model, **user_input)
        print(f"\nğŸ  GiÃ¡ nhÃ  dá»± Ä‘oÃ¡n: ${predicted_price:.1f}k")
        
        # ÄÃ¡nh giÃ¡
        if predicted_price > 30:
            print("   â†’ Khu vá»±c cao cáº¥p! ğŸ˜ï¸")
        elif predicted_price > 20:
            print("   â†’ Khu vá»±c trung bÃ¬nh khÃ¡ ğŸ ")
        elif predicted_price > 15:
            print("   â†’ Khu vá»±c trung bÃ¬nh ğŸ˜ï¸")
        else:
            print("   â†’ Khu vá»±c bÃ¬nh dÃ¢n ğŸšï¸")
    else:
        print("âš ï¸  Cáº§n nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng sá»‘ Ä‘á»ƒ dá»± Ä‘oÃ¡n!")

# Cháº¡y cÃ¡c vÃ­ dá»¥ dá»± Ä‘oÃ¡n
predict_with_examples()

print("\n" + "="*60)
print("Báº¡n cÃ³ thá»ƒ gá»i predict_custom() Ä‘á»ƒ nháº­p thÃ´ng sá»‘ tÃ¹y chá»‰nh")
print("Hoáº·c dÃ¹ng predict_house_price(best_model, LSTAT=10, RM=6, ...)")
print("="*60)
